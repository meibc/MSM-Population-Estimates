---
title: "MSM Population Estimates – September 2025"
author: "Meibin Chen"
date: "`r Sys.Date()`"
output: html_document
params:
simulations: 100000
chunk_size: 5000
---
# Load libraries
```{r}
library(tidyverse)
library(tidycensus)
library(arrow)
library(survey)
library(stringr)
```

# Load parameter data
```{r}
# ---- 2. Load parameter data ----
load('pop_est_params.RData')
```

# Helper functions
```{r}
logit     <- function(p) log(p/(1-p))
inv_logit <- function(x) 1/(1+exp(-x))

sim_logitnormal_vec <- function(p_vec, se_vec, n_draws) {
  mu  <- logit(p_vec)
  sel <- se_vec / (p_vec * (1 - p_vec))
  out <- matrix(NA_real_, nrow = length(p_vec), ncol = n_draws)
  
  for (k in seq_along(p_vec)) {
    draws <- inv_logit(rnorm(n_draws, mu[k], sel[k]))
    # Clamp to [0, 1]
    draws[draws < 0] <- 0
    draws[draws > 1] <- 1
    out[k, ] <- draws
  }
  out
}
```

# Set up parameters
```{r}
set.seed(123)
n_sim <- 100000L
n_chunk <- 5000L
nC <- length(nchscodes$GEOID)

countyid = 1:nC
county = nchscodes$GEOID[countyid]
county_to_stateurb  <- params$state_urb_id[countyid]
county_urb_code     <- nchscodes$Urbanicity[countyid]
county_to_urb <- params$Urbanicity[countyid]
county_to_urb <- as.integer(factor(county_to_urb, levels = c("Large.Central", "Large.Fringe", "Medium.Small", "Nonmetro.Rural")))

county_to_urb[is.na(county_to_urb)] <- 1  # fallback to valid index

n_age <- params_acs_dem %>% 
  filter(Category == "Age") %>% 
  pull(factor_lev) %>% 
  n_distinct()
n_educ <- params_acs_dem %>% 
  filter(Category == "Education") %>% 
  pull(factor_lev) %>% 
  n_distinct()
n_income <- params_acs_dem %>%
  filter(Category == "Income") %>% 
  pull(factor_lev) %>% 
  n_distinct()
n_urb <- length(unique(params_gss_age$Urbanicity))
ages <- params_acs_dem %>% 
  filter(Category == "Age") %>% 
  pull(factor_lev) %>% 
  unique()
educs <- params_acs_dem %>% 
  filter(Category == "Education") %>% 
  pull(factor_lev) %>% 
  unique()
incomes <- params_acs_dem %>% 
  filter(Category == "Income") %>% 
  pull(factor_lev) %>% 
  unique()

urb_levels <- c("Large.Central", "Large.Fringe", "Medium.Small", "Nonmetro.Rural")

params_county <- params %>% 
  filter(GEOID %in% county)

# Precompute GSS base rate once per county (simulated later)
gss_p  <- params_gss$msm[county_to_urb]
gss_se <- params_gss$se[county_to_urb]

# Lookup table for demographic configs
dem_config <- list(
  age = list(
    n       = n_age,
    levels  = ages,
    params  = params_gss_dem %>% filter(Category == "agecat"),
    varname = "agecat"
  ),
  educ = list(
    n       = n_educ,
    levels  = educs,     # not educ_levels
    params  = params_gss_dem %>% filter(Category == "educat"),
    varname = "educat"
  ),
  income = list(
    n       = n_income,
    levels  = incomes,   # not income_levels
    params  = params_gss_dem %>% filter(Category == "inccat"),
    varname = "inccat"
  )
)

# Output directory
dir.create("msm_draws", showWarnings = FALSE)
dir.create("male_draws", showWarnings = FALSE)
```

# Male Population Simulation by County, Demographics
```{r}
for (j in seq(1L, n_sim, by = n_chunk)) {
  idx <- j:min(j + n_chunk - 1L, n_sim)
  m   <- length(idx)
  chunk_id <- paste0(idx[1], "_", idx[m])
  message("Processing draws ", idx[1], " – ", idx[m])
  
  # --- Males 18+ ---
  male_blk <- matrix(
    rnorm(nC * m, mean = params_county$male_18_plus_est, sd = params_county$male_18_plus_sd),
    nrow = nC, ncol = m
  )
  
  male_blk[male_blk < 0] = 0
  
  save_path <- file.path("male_draws", paste0("male_blk_", chunk_id, ".parquet"))
  arrow::write_parquet(as.data.frame(male_blk), save_path)
  # --- Males 18+ by Age Group ---
  male_age_blk <- array(NA_real_, dim = c(n_age, nC, m))
  
  for (a in 1:n_age) {
    means_male_age <- params_acs_dem %>%
      filter(Category == "Age", factor_lev == ages[a]) %>%
      pull(est)
    
    sd_male_age <- params_acs_dem %>%
      filter(Category == "Age", factor_lev == ages[a]) %>%
      pull(moe_se)
    
    male_age_blk[a,,] <- matrix(
      rnorm(nC * m, mean = means_male_age, sd = sd_male_age),
      nrow = nC, ncol = m
    )
  }
  
  male_age_blk[male_age_blk < 0] <- 0
  
  male_age_df <- as.data.frame.table(male_age_blk, responseName = "male_pop") %>%
    rename(age = Var1, county_index = Var2, sim_index = Var3) %>%
    mutate(
      age = as.integer(age),
      county_index = as.integer(county_index),
      sim_index = as.integer(sim_index)
    )
  
  arrow::write_parquet(
    male_age_df,
    file.path("male_draws", paste0("adj_male_age_blk", chunk_id, ".parquet"))
  )
  
  # --- Males 18+ by Education ---
  male_educ_blk <- array(NA_real_, dim = c(n_educ, nC, m))
  for (a in 1:n_educ) {
    means_male_educ <- params_acs_dem %>% 
      filter(Category == "Education", factor_lev == educs[a]) %>% pull(est)
    sd_male_educ <- params_acs_dem %>% 
      filter(Category == "Education", factor_lev == educs[a]) %>% pull(moe_se)
    male_educ_blk[a,,] <- matrix(
      rnorm(nC * m, mean = means_male_educ, sd = sd_male_educ),
      nrow = nC, ncol = m
    )
  }
  
  male_educ_blk[male_educ_blk < 0] = 0
  
  male_educ_df <- as.data.frame.table(male_educ_blk, responseName = "male_pop") %>%
    rename(educ = Var1, county_index = Var2, sim_index = Var3)
  male_educ_df <- male_educ_df %>% mutate(
    educ = as.integer(educ),
    county_index = as.integer(county_index),
    sim_index = as.integer(sim_index)
  )
  arrow::write_parquet(male_educ_df, file.path("male_draws", paste0("adj_male_educ_blk", chunk_id, ".parquet")))
  
  # --- Males 18+ by Income ---
  male_income_blk <- array(NA_real_, dim = c(n_income, nC, m))
  for (a in 1:n_income) {
    means_male_income <- params_acs_dem %>% 
      filter(Category == "Income", factor_lev == incomes[a]) %>% pull(est)
    sd_male_income <- params_acs_dem %>% 
      filter(Category == "Income", factor_lev == incomes[a]) %>% pull(moe_se)
    male_income_blk[a,,] <- matrix(
      rnorm(nC * m, mean = means_male_income, sd = sd_male_income),
      nrow = nC, ncol = m
    )
  }
  
  male_income_blk[male_income_blk < 0] = 0
  
  male_income_df <- as.data.frame.table(male_income_blk, responseName = "male_pop") %>%
    rename(income = Var1, county_index = Var2, sim_index = Var3)
  male_income_df <- male_income_df %>% mutate(
    income = as.integer(income),
    county_index = as.integer(county_index),
    sim_index = as.integer(sim_index)
  )
  arrow::write_parquet(male_income_df, file.path("male_draws", paste0("adj_male_income_blk", chunk_id, ".parquet")))
  
  # Cleanup
  rm(male_age_blk, male_age_df, male_blk, male_educ_blk, male_educ_df, male_income_blk, male_income_df)
  gc()
}
```

# MSM Population by County
```{r}
# Loop over chunks
for (j in seq(1L, n_sim, by = n_chunk)) {
  idx <- j:min(j + n_chunk - 1L, n_sim)
  m   <- length(idx)
  chunk_id <- paste0(idx[1], "_", idx[m])
  message("Processing draws ", idx[1], "–", idx[m])
  
  # Simulate SSM
  ss_block <- matrix(
    rlnorm(nC * m, 
           meanlog = params_county$ss_params_ssmu, 
           sdlog   = params_county$ss_params_sssigma), 
    nrow = nC, ncol = m
  )
  ss_block[is.na(ss_block)] <- 0
  
  # Simulate MM SSHH and FF SSHH
  mm_block <- matrix(
    rnorm(n = nC * m, 
          mean = params_county$mm_est, 
          sd   = params_county$mm_se), 
    nrow = nC, ncol = m
  )
  
  ff_block <- matrix(
    rnorm(n = nC * m, 
          mean = params_county$ff_est, 
          sd   = params_county$ff_se),
    nrow = nC, ncol = m
  )
  
  mm_block[mm_block < 0] <- 0
  ff_block[ff_block < 0] <- 0
  
  m_f_ratio <- mm_block / (mm_block + ff_block)
  ssm_block <- m_f_ratio * ss_block
  
  hh_block <- matrix(
    params_county$total_households_est, 
    nrow = nC, ncol = m, byrow = FALSE
  )
  
  # --- Urbanicity SSM/HH mean ---
  ssm_urb <- do.call(rbind, lapply(1:4, function(u) {
    rows <- which(county_to_urb == u)
    sum_ssm <- colSums(ssm_block[rows, , drop = FALSE], na.rm = TRUE)
    sum_hh  <- colSums(hh_block[rows, , drop = FALSE], na.rm = TRUE)
    sum_ssm / sum_hh
  }))  # 4 x m
  
  ssm_urb_block <- ssm_urb[county_to_urb, ]  # nC x m
  
  # --- Adjusted MSM Index ---
  adj_ssm_block <- ssm_block + hh_block * ssm_urb_block
  adj_hh_block  <- hh_block  + hh_block * ssm_urb_block
  msm_index_blk <- (adj_ssm_block / adj_hh_block) / ssm_urb_block
  
  # --- Males 18+ ---
  male_blk_filepath <- file.path("male_draws", paste0("male_blk_", chunk_id, ".parquet"))
  male_blk <- as.matrix(arrow::read_parquet(male_blk_filepath))
  
  # --- GSS base rate ---
  gss_blk <- sim_logitnormal_vec(gss_p, gss_se, m)  # 4 x m
  gss_blk_by_cty <- gss_blk[county_to_urb, ]  # nC x m
  
  # --- Final MSM draw ---
  msm_blk <- male_blk * msm_index_blk * gss_blk_by_cty  # nC x m
  msm_blk[msm_blk < 0] <- 0
  
  # --- Save ---
  save_path <- file.path("msm_draws", paste0("msm_blk_", chunk_id, ".parquet"))
  arrow::write_parquet(as.data.frame(msm_blk), save_path)
  
  rm(
    ss_block, mm_block, ff_block, m_f_ratio,
    ssm_block, hh_block, ssm_urb, ssm_urb_block,
    adj_ssm_block, adj_hh_block, msm_index_blk,
    male_blk, gss_blk, gss_blk_by_cty, msm_blk
  )
  gc()
}
```

# Function for demographic-specific MSM Simulations
```{r}
f_dem_sim <- function(dem = c("age", "educ", "income")) {
  dem <- match.arg(dem)
  
  # pull the config for this demographic
  cfg <- dem_config[[dem]]
  n_dem   <- cfg$n
  levels  <- cfg$levels
  params  <- cfg$params
  dem_var <- cfg$varname
  
  for (j in seq(1L, n_sim, by = n_chunk)) {
    idx <- j:min(j + n_chunk - 1L, n_sim)
    m   <- length(idx)
    chunk_id <- paste0(idx[1], "_", idx[m])
    message("Processing ", dem, "-specific MSM draws: ", chunk_id)
    
    msm_blk_filepath  <- file.path("msm_draws",  paste0("msm_blk_", chunk_id, ".parquet"))
    male_blk_filepath <- file.path("male_draws", paste0("male_blk_", chunk_id, ".parquet"))
    male_dem_filepath <- file.path("male_draws", paste0("adj_male_", dem, "_blk", chunk_id, ".parquet"))
    
    msm_blk      <- as.matrix(arrow::read_parquet(msm_blk_filepath))
    male_blk     <- as.matrix(arrow::read_parquet(male_blk_filepath))
    male_dem_blk <- as.matrix(arrow::read_parquet(male_dem_filepath))
    
    male_dem_blk <- array(male_dem_blk[, "male_pop"], dim = c(n_dem, nC, m))
    
    print(sum(is.na(male_dem_blk)))
    
    gss_dem_blk <- array(NA_real_, dim = c(n_dem, n_urb, m))
    for (d in seq_len(n_dem)) {
      for (u in seq_len(n_urb)) {
        row <- params_gss_dem[params_gss_dem$Category == dem_var & 
                 params_gss_dem$factor_lev == levels[d] & 
                 params_gss_dem$Urbanicity == urb_levels[u], ]
        gss_dem_blk[d, u, ] <- sim_logitnormal_vec(row$msm, row$se, m)
      }
    }
    
    # print(sum(is.na(gss_dem_blk)))
    
    gss_dem_blk_by_cty <- gss_dem_blk[, county_to_urb, ]
    msm_dem_blk <- male_dem_blk * gss_dem_blk_by_cty
    
    # print(sum(is.na(msm_dem_blk)))
    
    pred_msm_county <- apply(msm_dem_blk, MARGIN = c(2, 3), FUN = sum)
    pred_msm_county_expanded <- array(rep(pred_msm_county, each = n_dem),
                                      dim = c(n_dem, nC, m))
    
    prop_msm_blk <- msm_dem_blk / pred_msm_county_expanded
    msm_blk_expanded <- array(rep(msm_blk, each = n_dem), dim = c(n_dem, nC, m))
    
    # print(sum(prop_msm_blk[,1,1]))
    # print(sum(prop_msm_blk > 1, na.rm = TRUE))
    
    adj_msm_dem_blk <- prop_msm_blk * msm_blk_expanded
    
    adj_df <- as.data.frame.table(adj_msm_dem_blk, responseName = "msm_count")
    colnames(adj_df) <- c(dem, "county_index", "sim_index", "msm_count")
    adj_df[[dem]] <- as.integer(adj_df[[dem]])
    adj_df$county_index <- as.integer(adj_df$county_index)
    adj_df$sim_index    <- as.integer(adj_df$sim_index)
    
    outfile <- file.path("msm_draws", paste0("adj_msm_", dem, "_blk_", chunk_id, ".parquet"))
    arrow::write_parquet(adj_df, outfile)

    rm(msm_blk, male_blk, male_dem_blk,
       gss_dem_blk, gss_dem_blk_by_cty,
       msm_dem_blk, pred_msm_county, pred_msm_county_expanded,
       prop_msm_blk, msm_blk_expanded, adj_msm_dem_blk,
       adj_df)

    gc()
  }
}
```

# Run demographic-specific MSM simulations
```{r}
f_dem_sim("age")
f_dem_sim("educ")
f_dem_sim("income")
```







