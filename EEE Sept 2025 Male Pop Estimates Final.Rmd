---
title: "MSM Population Estimates – September 2025"
author: "Meibin Chen"
date: "`r Sys.Date()`"
output: html_document
params:
simulations: 100000
chunk_size: 5000
---

```{r}
# ---- 1. Load libraries ----
library(tidyverse)
library(tidycensus)
library(arrow)
library(survey)
library(stringr)
```

```{r}
# ---- 2. Load parameter data ----
load('pop_est_params.RData')
```

```{r}
# ---- 3. Helper functions ----
logit     <- function(p) log(p/(1-p))
inv_logit <- function(x) 1/(1+exp(-x))

sim_logitnormal_vec <- function(p_vec, se_vec, n_draws) {
  # p_vec, se_vec are length K; returns K × n_draws matrix
  mu  <- logit(p_vec)
  sel <- se_vec / (p_vec*(1-p_vec))
  out <- matrix(NA_real_, nrow = length(p_vec), ncol = n_draws)
  for (k in seq_along(p_vec)) {
    out[k, ] <- inv_logit(rnorm(n_draws, mu[k], sel[k]))
  }
  out
}
```

```{r}
set.seed(123)
n_sim <- 100000L
n_chunk <- 5000L
nC <- length(nchscodes$GEOID)

countyid = 1:nC
county = nchscodes$GEOID[countyid]
county_to_stateurb  <- params$state_urb_id[countyid]
county_urb_code     <- nchscodes$Urbanicity[countyid]
county_to_urb <- params$Urbanicity[countyid]
county_to_urb <- as.integer(factor(county_to_urb, levels = c("Large.Central", "Large.Fringe", "Medium.Small", "Nonmetro.Rural")))

county_to_urb[is.na(county_to_urb)] <- 1  # fallback to valid index
n_age <- length(unique(params_age_acs$age_group))
n_urb <- length(unique(params_gss_age$Urbanicity))
ages <- unique(params_age_acs$age_group)
urb_levels <- c("Large.Central", "Large.Fringe", "Medium.Small", "Nonmetro.Rural")

params_county <- params %>% 
  filter(GEOID %in% county)

# Precompute GSS base rate once per county (simulated later)
gss_p  <- params_gss$msm[county_to_urb]
gss_se <- params_gss$se[county_to_urb]

# Output directory
dir.create("msm_draws", showWarnings = FALSE)
dir.create("male_draws", showWarnings = FALSE)

```
# Male Population Simulation by County, Demographics
```{r}
for (j in seq(1L, n_sim, by = n_chunk)) {
  idx <- j:min(j + n_chunk - 1L, n_sim)
  m   <- length(idx)
  chunk_id <- paste0(idx[1], "_", idx[m])
  message("Processing draws ", idx[1], "–", idx[m])
  
  # --- Males 18+ ---
  male_blk <- matrix(
    rnorm(nC * m, 
          mean = params_county$male_18_plus_est, 
          sd   = params_county$male_18_plus_sd), 
    nrow = nC, ncol = m
  )
  
  save_path <- file.path("male_draws", paste0("male_blk_", chunk_id, ".parquet"))
  arrow::write_parquet(as.data.frame(male_blk), save_path)
  
  # --- Males 18+ by Age Group --- 
  male_age_blk <- array(NA_real_, dim = c(n_age, nC, m))
  
  for (a in 1:n_age) {
    means_male_age <- params_age_acs %>% 
      filter(age_group == ages[a]) %>%
      pull(est)
    sd_male_age <- params_age_acs %>%
      filter(age_group == ages[a]) %>%
      pull(moe_se)
    male_age_blk[a,,] <- matrix(
      rnorm(nC * m, mean = means_male_age, sd = sd_male_age),
      nrow = nC, ncol = m
    )
  }
  
  male_age_df <- as.data.frame.table(male_age_blk, responseName = "male_pop")
  colnames(male_age_df) <- c("age_group", "county_index", "sim_index", "male_pop")
  
  # Convert indices to integers
  male_age_df$age_group    <- as.integer(male_age_df$age_group)
  male_age_df$county_index <- as.integer(male_age_df$county_index)
  male_age_df$sim_index    <- as.integer(male_age_df$sim_index)
  
  savepath <- file.path("male_draws", paste0("adj_male_age_blk", chunk_id, ".parquet"))
  arrow::write_parquet(male_age_df, savepath)
  
  rm(male_age_blk, male_age_df, male_blk)
  gc()
}
```

```{r}
# Loop over chunks
for (j in seq(1L, n_sim, by = n_chunk)) {
  idx <- j:min(j + n_chunk - 1L, n_sim)
  m   <- length(idx)
  chunk_id <- paste0(idx[1], "_", idx[m])
  message("Processing draws ", idx[1], "–", idx[m])
  
  # Simulate SSM
  ss_block <- matrix(
    rlnorm(nC * m, 
           meanlog = params_county$ss_params_ssmu, 
           sdlog   = params_county$ss_params_sssigma), 
    nrow = nC, ncol = m
  )
  ss_block[is.na(ss_block)] <- 0
  
  # Simulate MM SSHH and FF SSHH
  mm_block <- matrix(
    rnorm(n = nC * m, 
          mean = params_county$mm_est, 
          sd   = params_county$mm_se), 
    nrow = nC, ncol = m
  )
  
  ff_block <- matrix(
    rnorm(n = nC * m, 
          mean = params_county$ff_est, 
          sd   = params_county$ff_se),
    nrow = nC, ncol = m
  )
  
  m_f_ratio <- mm_block / (mm_block + ff_block)
  ssm_block <- m_f_ratio * ss_block
  
  hh_block <- matrix(
    params_county$total_households_est, 
    nrow = nC, ncol = m, byrow = FALSE
  )
  
  # --- Urbanicity SSM/HH mean ---
  ssm_urb <- do.call(rbind, lapply(1:4, function(u) {
    rows <- which(county_to_urb == u)
    sum_ssm <- colSums(ssm_block[rows, , drop = FALSE], na.rm = TRUE)
    sum_hh  <- colSums(hh_block[rows, , drop = FALSE], na.rm = TRUE)
    sum_ssm / sum_hh
  }))  # 4 x m
  
  ssm_urb_block <- ssm_urb[county_to_urb, ]  # nC x m
  
  # --- Adjusted MSM Index ---
  adj_ssm_block <- ssm_block + hh_block * ssm_urb_block
  adj_hh_block  <- hh_block  + hh_block * ssm_urb_block
  msm_index_blk <- (adj_ssm_block / adj_hh_block) / ssm_urb_block
  
  # --- Males 18+ ---
  male_blk_filepath <- file.path("male_draws", paste0("male_blk_", chunk_id, ".parquet"))
  male_blk <- as.matrix(arrow::read_parquet(male_blk_filepath))
  
  # --- GSS base rate ---
  gss_blk <- sim_logitnormal_vec(gss_p, gss_se, m)  # 4 x m
  gss_blk_by_cty <- gss_blk[county_to_urb, ]  # nC x m
  
  # --- Final MSM draw ---
  msm_blk <- male_blk * msm_index_blk * gss_blk_by_cty  # nC x m
  
  # --- Save ---
  save_path <- file.path("msm_draws", paste0("msm_blk_", chunk_id, ".parquet"))
  arrow::write_parquet(as.data.frame(msm_blk), save_path)
  
  rm(
    ss_block, mm_block, ff_block, m_f_ratio,
    ssm_block, hh_block, ssm_urb, ssm_urb_block,
    adj_ssm_block, adj_hh_block, msm_index_blk,
    male_blk, gss_blk, gss_blk_by_cty, msm_blk
  )
  gc()
}
```

```{r}
 # --- [1] Simulate male population by age group per county (normal)
for (j in seq(1L, n_sim, by = n_chunk)) {
  idx <- j:min(j + n_chunk - 1L, n_sim)
  m   <- length(idx)
  chunk_id <- paste0(idx[1], "_", idx[m])
  message("Processing age-specific MSM draws: ", chunk_id)
  
  msm_blk_filepath <- file.path("msm_draws", paste0("msm_blk_", chunk_id, ".parquet"))
  male_blk_filepath <- file.path("male_draws", paste0("male_blk_", chunk_id, ".parquet"))
  male_age_blk_filepath <- file.path("male_draws", paste0("adj_male_age_blk", chunk_id, ".parquet"))
    
  msm_blk <- as.matrix(arrow::read_parquet(msm_blk_filepath))
  male_blk <- as.matrix(arrow::read_parquet(male_blk_filepath))
  male_age_blk <- as.matrix(arrow::read_parquet(male_age_blk_filepath))
  
  male_age_blk <- array(male_age_blk[, "male_pop"], 
                      dim = c(n_age, nC, m))
  
  # print(sum(is.na(male_age_blk)))
  
  # --- Get GSS base rates for each age group × urbanicity
  gss_age_blk <- array(NA_real_, dim = c(n_age, n_urb, m))
  
  for (a in seq_len(n_age)) {
    for (u in seq_len(n_urb)) {
      row <- params_gss_age[params_gss_age$agecat == ages[a] &
                              params_gss_age$Urbanicity == urb_levels[u],]
      gss_age_blk[a, u, ] <- sim_logitnormal_vec(row$msm, row$se, m)
    }
  }
  
  print(sum(is.na(gss_age_blk)))
  
  gss_age_blk_by_cty <- gss_age_blk[, county_to_urb, ]  # shape: age x county x sim
  
  # --- Calculate age-specific MSM block
  msm_age_blk <- male_age_blk * gss_age_blk_by_cty  # shape: age x county x sim
  
  # --- Sum over ages to get total MSM per county (same as Step 1 in figure)
  pred_msm_county <- apply(msm_age_blk, MARGIN = c(2, 3), FUN = sum)
  
  # --- Expand to divide each age-specific MSM estimate by total
  pred_msm_county_expanded <- array(
    rep(pred_msm_county, each = n_age),  # repeat each value 5 times
    dim = c(n_age, nC, m)
  )
  # Now divide element-wise
  prop_msm_blk <- msm_age_blk / pred_msm_county_expanded # 5 x nC x n_sim
  
  print(sum(prop_msm_blk[,1,1]))
  
  msm_blk_expanded <- array(rep(msm_blk, each = n_age),
                            dim = c(n_age, nC, m))
  
  print(msm_blk_expanded[,1,1])
  adj_msm_age_blk  <- prop_msm_blk * msm_blk_expanded  # <- total MSM from previous step
  
  print(adj_msm_age_blk[,1,1])
  
  adj_df <- as.data.frame.table(adj_msm_age_blk, responseName = "msm_count")
  colnames(adj_df) <- c("age_group", "county_index", "sim_index", "msm_count")
  
  adj_df$age_group     <- as.integer(adj_df$age_group)
  adj_df$county_index  <- as.integer(adj_df$county_index)
  adj_df$sim_index     <- as.integer(adj_df$sim_index)
  
  outfile <- file.path("msm_draws", paste0("adj_msm_age_blk_", chunk_id, ".parquet"))
  arrow::write_parquet(adj_df, outfile)
  
  rm(
    msm_blk, male_blk, male_age_blk,
    gss_age_blk, gss_age_blk_by_cty,
    msm_age_blk, pred_msm_county, pred_msm_county_expanded,
    prop_msm_blk, msm_blk_expanded, adj_msm_age_blk,
    adj_df
  )
  gc()
}



```


